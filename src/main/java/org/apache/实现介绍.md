# Flink作业管理组件

## 概述
本文档描述了在InLong Manager中基于实时数据速率动态调整Flink作业并发度所使用的组件。这些组件协同工作以监控数据处理速率、计算最佳任务槽数（并发度），并在提交作业前相应调整作业设置。

## 组件介绍

### DataRateMonitorFunction

- **功能**：监控Flink作业的数据处理速率。
- **实现方法**：该函数扩展自`RichFlatMapFunction`，利用Flink的`Metric`系统实时监控并记录每秒处理的记录数。此数据可用于后续的并发度计算。
- **关键实现**：
  - 在`open`方法中注册一个`Gauge`指标，每秒计算并更新记录处理速率。
  - 将计算得到的速率保存至数据库或变量中，用于历史分析。

### ParallelismCalculator

- **功能**：根据数据速率计算最优并发度。
- **实现方法**：提供一个静态方法`calculateOptimalParallelism`，根据传入的每秒数据记录数，按照每核心每秒可处理的记录数（默认1000条/秒/核）计算并返回所需的并发度。
- **计算逻辑**：
  - 根据数据速率计算并发度：`parallelism = Math.ceil(dataPerSecond / RECORDS_PER_SECOND_PER_CORE)`。
  - 确保并发度至少为1。

### JobSubmitter

- **功能**：通过指定的保存点提交Flink作业，并动态计算并设置并发度。
- **实现方法**：
  - 首先从`DataRateMonitorFunction`获取历史数据速率的平均值。
  - 使用`ParallelismCalculator`根据平均数据速率计算所需的并发度。
  - 根据计算得到的并发度配置`JobGraph`并提交Flink作业。
- **细节描述**：
  - 从Flink信息对象`flinkInfo`中获取必要的作业配置，如JAR文件路径和程序参数。
  - 配置并使用`PackagedProgram`和`JobGraph`来设置作业的并行度并提交至Flink集群。

## 关系和工作流程
- `DataRateMonitorFunction`在Flink作业运行期间实时监控数据速率，并将速率信息保存供后续使用。
- `ParallelismCalculator`根据`DataRateMonitorFunction`提供的数据速率计算出最佳并发度。
- `JobSubmitter`利用了整合上述两个组件的功能，使用历史数据速率计算并发度，并在作业提交前设置相应的并发度。

以上组件设计确保了Flink作业根据实时性能数据动态调整资源配置，优化了资源利用效率和作业执行性能。
